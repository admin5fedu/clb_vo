<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Điểm danh</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
    <div class="container mx-auto p-6 bg-white rounded-xl shadow-lg w-full max-w-6xl">
        <h1 class="text-3xl font-bold text-center mb-6 text-gray-800">Dữ liệu từ Google Apps Script</h1>

        <!-- Khu vực bộ lọc -->
        <div class="mb-6 grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
                <label for="filter-date" class="block text-sm font-medium text-gray-700">Năm tháng</label>
                <select id="filter-date"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                    <option value="">-- Tất cả Năm tháng --</option>
                </select>
            </div>
            <div>
                <label for="filter-dojo" class="block text-sm font-medium text-gray-700">Võ đường</label>
                <select id="filter-dojo"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                    <option value="">-- Tất cả Võ đường --</option>
                </select>
            </div>
            <div>
                <label for="filter-student" class="block text-sm font-medium text-gray-700">Học viên</label>
                <input type="text" id="filter-student" placeholder="Nhập tên học viên..."
                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
            </div>
        </div>

        <div id="loading" class="text-center text-gray-500 mb-4">Đang tải dữ liệu...</div>
        <div id="data-container" class="overflow-x-auto rounded-lg shadow-inner">
            <!-- Dữ liệu sẽ được hiển thị ở đây -->
        </div>
        <div id="error-message" class="hidden text-center text-red-500 mt-4 font-semibold">
            Có lỗi xảy ra khi tải dữ liệu. Vui lòng thử lại sau.
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const dataContainer = document.getElementById('data-container');
            const loadingIndicator = document.getElementById('loading');
            const errorMessage = document.getElementById('error-message');
            // Cập nhật URL webapp mới
            const url = 'https://script.google.com/macros/s/AKfycbwx3TSJYH5WVZP5lE-fqeUx2N-gkIxDi9Ljzb4ZRlVmxlu-8iaZ8pZWRzGSVCmlzk_i/exec';

            // Các phần tử lọc
            const filterDateSelect = document.getElementById('filter-date');
            const filterDojoSelect = document.getElementById('filter-dojo');
            const filterStudentInput = document.getElementById('filter-student');
            let originalData = [];

            // Hàm để lấy dữ liệu từ API
            async function fetchData() {
                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    const data = await response.json();
                    originalData = data; // Lưu trữ dữ liệu gốc
                    populateFilters(data);
                    filterData(); // Hiển thị dữ liệu lần đầu
                } catch (error) {
                    console.error('Lỗi khi lấy dữ liệu:', error);
                    loadingIndicator.classList.add('hidden');
                    errorMessage.classList.remove('hidden');
                }
            }

            // Hàm để điền dữ liệu cho các bộ lọc
            function populateFilters(data) {
                // Lọc và điền dữ liệu cho dropdown Năm tháng
                const dates = [...new Set(data.map(item => item['Date']))];
                dates.sort().reverse(); // Sắp xếp từ Z đến A
                dates.forEach(date => {
                    const option = document.createElement('option');
                    option.value = date;
                    option.textContent = date;
                    filterDateSelect.appendChild(option);
                });

                // Tự động chọn năm tháng hiện tại
                const now = new Date();
                const currentMonth = (now.getMonth() + 1).toString().padStart(2, '0');
                const currentDateString = `${now.getFullYear()}/${currentMonth}`;
                filterDateSelect.value = currentDateString;

                // Lọc và điền dữ liệu cho dropdown Võ đường
                const dojos = [...new Set(data.map(item => item['Võ đường']))];
                dojos.forEach(dojo => {
                    const option = document.createElement('option');
                    option.value = dojo;
                    option.textContent = dojo;
                    filterDojoSelect.appendChild(option);
                });
            }

            // Hàm lọc dữ liệu
            function filterData() {
                loadingIndicator.classList.add('hidden');
                const dateFilter = filterDateSelect.value;
                const dojoFilter = filterDojoSelect.value;
                const studentFilter = filterStudentInput.value.toLowerCase().trim();

                const filteredData = originalData.filter(row => {
                    // Lọc theo Năm tháng (YYYY/MM)
                    const dateMatch = !dateFilter || row['Date'] === dateFilter;

                    // Lọc theo Võ đường
                    const dojoMatch = !dojoFilter || row['Võ đường'] === dojoFilter;

                    // Lọc theo Học viên
                    const studentMatch = !studentFilter || row['Học viên'].toLowerCase().includes(studentFilter);
                    
                    return dateMatch && dojoMatch && studentMatch;
                });

                displayData(filteredData);
            }

            // Hàm để hiển thị dữ liệu lên trang
            function displayData(data) {
                if (!data || data.length === 0) {
                    dataContainer.innerHTML = '<p class="text-center text-gray-500 p-4">Không có dữ liệu để hiển thị.</p>';
                    return;
                }

                let html = '<table class="min-w-full bg-white rounded-lg">';

                // Tạo tiêu đề bảng (header)
                const headers = Object.keys(data[0]);
                html += '<thead><tr class="bg-blue-600 text-white">';
                headers.forEach(header => {
                    html += `<th class="py-3 px-4 text-left font-semibold">${header}</th>`;
                });
                html += '</tr></thead>';

                // Tạo nội dung bảng (body)
                html += '<tbody>';
                data.forEach((row, index) => {
                    const rowClass = index % 2 === 0 ? 'bg-gray-100' : 'bg-white';
                    html += `<tr class="${rowClass} hover:bg-gray-200 transition-colors duration-200">`;
                    headers.forEach(header => {
                        html += `<td class="py-3 px-4 border-b border-gray-200">${row[header]}</td>`;
                    });
                    html += '</tr>';
                });
                html += '</tbody>';
                html += '</table>';
                dataContainer.innerHTML = html;
            }

            // Thêm sự kiện lắng nghe cho các bộ lọc
            filterDateSelect.addEventListener('change', filterData);
            filterDojoSelect.addEventListener('change', filterData);
            filterStudentInput.addEventListener('input', filterData);

            // Gọi hàm để lấy dữ liệu
            fetchData();
        });
    </script>
</body>
</html>
