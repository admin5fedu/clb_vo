<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Điểm danh</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .rotated-text {
            writing-mode: vertical-rl;
            transform: rotate(180deg);
        }
        th, td {
            white-space: nowrap;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
    <div class="container mx-auto p-6 bg-white rounded-xl shadow-lg w-full max-w-6xl">
        <h1 class="text-3xl font-bold text-center mb-6 text-gray-800">Bảng Điểm Danh Chi Tiết</h1>

        <!-- Khu vực bộ lọc -->
        <div class="mb-6 grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
                <label for="filter-date" class="block text-sm font-medium text-gray-700">Năm tháng</label>
                <select id="filter-date"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                    <option value="">-- Tất cả Năm tháng --</option>
                </select>
            </div>
            <div>
                <label for="filter-dojo" class="block text-sm font-medium text-gray-700">Võ đường</label>
                <select id="filter-dojo"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                    <option value="">-- Tất cả Võ đường --</option>
                </select>
            </div>
            <div>
                <label for="filter-student" class="block text-sm font-medium text-gray-700">Học viên</label>
                <input type="text" id="filter-student" placeholder="Nhập tên học viên..."
                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
            </div>
        </div>

        <div id="loading" class="text-center text-gray-500 mb-4">Đang tải dữ liệu...</div>
        <div id="data-container" class="overflow-x-auto rounded-lg shadow-inner">
            <!-- Dữ liệu sẽ được hiển thị ở đây -->
        </div>
        <div id="error-message" class="hidden text-center text-red-500 mt-4 font-semibold">
            Có lỗi xảy ra khi tải dữ liệu. Vui lòng thử lại sau.
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const dataContainer = document.getElementById('data-container');
            const loadingIndicator = document.getElementById('loading');
            const errorMessage = document.getElementById('error-message');
            // Cập nhật URL webapp mới
            const url = 'https://script.google.com/macros/s/AKfycbwx3TSJYH5WVZP5lE-fqeUx2N-gkIxDi9Ljzb4ZRlVmxlu-8iaZ8pZWRzGSVCmlzk_i/exec';

            // Các phần tử lọc
            const filterDateSelect = document.getElementById('filter-date');
            const filterDojoSelect = document.getElementById('filter-dojo');
            const filterStudentInput = document.getElementById('filter-student');
            let originalData = [];

            // Hàm để lấy dữ liệu từ API
            async function fetchData() {
                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    const data = await response.json();
                    originalData = data; // Lưu trữ dữ liệu gốc
                    populateFilters(data);
                    filterData(); // Hiển thị dữ liệu lần đầu
                } catch (error) {
                    console.error('Lỗi khi lấy dữ liệu:', error);
                    loadingIndicator.classList.add('hidden');
                    errorMessage.classList.remove('hidden');
                }
            }

            // Hàm để điền dữ liệu cho các bộ lọc
            function populateFilters(data) {
                // Lọc và điền dữ liệu cho dropdown Năm tháng
                const dates = [...new Set(data.map(item => item['Date']))].sort().reverse();
                dates.forEach(date => {
                    const option = document.createElement('option');
                    option.value = date;
                    option.textContent = date;
                    filterDateSelect.appendChild(option);
                });

                // Tự động chọn năm tháng hiện tại
                const now = new Date();
                const currentMonth = (now.getMonth() + 1).toString().padStart(2, '0');
                const currentDateString = `${now.getFullYear()}/${currentMonth}`;
                filterDateSelect.value = currentDateString;

                // Lọc và điền dữ liệu cho dropdown Võ đường
                const dojos = [...new Set(data.map(item => item['Võ đường']))];
                dojos.forEach(dojo => {
                    const option = document.createElement('option');
                    option.value = dojo;
                    option.textContent = dojo;
                    filterDojoSelect.appendChild(option);
                });
            }

            // Hàm lọc dữ liệu
            function filterData() {
                loadingIndicator.classList.add('hidden');
                const dateFilter = filterDateSelect.value;
                const dojoFilter = filterDojoSelect.value;
                const studentFilter = filterStudentInput.value.toLowerCase().trim();

                const filteredData = originalData.filter(row => {
                    const dateMatch = !dateFilter || row['Date'] === dateFilter;
                    const dojoMatch = !dojoFilter || row['Võ đường'] === dojoFilter;
                    const studentMatch = !studentFilter || row['Học viên'].toLowerCase().includes(studentFilter);
                    
                    return dateMatch && dojoMatch && studentMatch;
                });

                displayData(filteredData);
            }

            // Hàm để hiển thị dữ liệu lên trang
            function displayData(data) {
                if (!data || data.length === 0) {
                    dataContainer.innerHTML = '<p class="text-center text-gray-500 p-4">Không có dữ liệu để hiển thị.</p>';
                    return;
                }

                // Xử lý dữ liệu để tạo bảng chi tiết
                const processedData = processData(data);
                
                let html = '<table class="min-w-full bg-white rounded-lg">';

                // Tạo tiêu đề bảng (header)
                html += '<thead><tr class="bg-blue-600 text-white">';
                html += '<th class="py-3 px-4 text-left font-semibold">TT</th>';
                html += '<th class="py-3 px-4 text-left font-semibold">Năm tháng</th>';
                html += '<th class="py-3 px-4 text-left font-semibold">Tên học viên</th>';
                for (let i = 1; i <= 31; i++) {
                    html += `<th class="py-3 px-2 font-semibold text-center">${i}</th>`;
                }
                html += '<th class="py-3 px-4 text-left font-semibold">Đến muộn</th>';
                html += '<th class="py-3 px-4 text-left font-semibold">Học đúng giờ</th>';
                html += '<th class="py-3 px-4 text-left font-semibold">Về chùa công quả</th>';
                html += '<th class="py-3 px-4 text-left font-semibold">Nghi phép</th>';
                html += '<th class="py-3 px-4 text-left font-semibold">Không Phép</th>';
                html += '<th class="py-3 px-4 text-left font-semibold">Vắng mặt</th>';
                html += '<th class="py-3 px-4 text-left font-semibold">Học thử</th>';
                html += '<th class="py-3 px-4 text-left font-semibold">Nghỉ hẳn</th>';
                html += '</tr></thead>';

                // Tạo nội dung bảng (body)
                html += '<tbody>';
                processedData.forEach((row, index) => {
                    const rowClass = index % 2 === 0 ? 'bg-gray-100' : 'bg-white';
                    html += `<tr class="${rowClass} hover:bg-gray-200 transition-colors duration-200">`;
                    html += `<td class="py-3 px-4 border-b border-gray-200">${index + 1}</td>`;
                    html += `<td class="py-3 px-4 border-b border-gray-200">${row['Năm tháng']}</td>`;
                    html += `<td class="py-3 px-4 border-b border-gray-200">${row['Tên học viên']}</td>`;
                    for (let i = 1; i <= 31; i++) {
                        const dayStatus = row.days[i] ? row.days[i] : '';
                        html += `<td class="py-3 px-2 border-b border-gray-200 text-center">${dayStatus}</td>`;
                    }
                    html += `<td class="py-3 px-4 border-b border-gray-200">${row['Đến muộn']}</td>`;
                    html += `<td class="py-3 px-4 border-b border-gray-200">${row['Học đúng giờ']}</td>`;
                    html += `<td class="py-3 px-4 border-b border-gray-200">${row['Về chùa công quả']}</td>`;
                    html += `<td class="py-3 px-4 border-b border-gray-200">${row['Nghi phép']}</td>`;
                    html += `<td class="py-3 px-4 border-b border-gray-200">${row['Không Phép']}</td>`;
                    html += `<td class="py-3 px-4 border-b border-gray-200">${row['Vắng mặt']}</td>`;
                    html += `<td class="py-3 px-4 border-b border-gray-200">${row['Học thử']}</td>`;
                    html += `<td class="py-3 px-4 border-b border-gray-200">${row['Nghỉ hẳn']}</td>`;
                    html += '</tr>';
                });
                html += '</tbody>';
                html += '</table>';
                dataContainer.innerHTML = html;
            }

            // Hàm xử lý dữ liệu để tạo bảng chi tiết
            function processData(data) {
                const detailedData = {};
                
                data.forEach(item => {
                    const date = item['Date'];
                    const studentName = item['Học viên'];
                    const key = `${date}-${studentName}`;

                    if (!detailedData[key]) {
                        detailedData[key] = {
                            'Năm tháng': date,
                            'Tên học viên': studentName,
                            'Đến muộn': 0,
                            'Học đúng giờ': 0,
                            'Về chùa công quả': 0,
                            'Nghi phép': 0,
                            'Không Phép': 0,
                            'Vắng mặt': 0,
                            'Học thử': 0,
                            'Nghỉ hẳn': 0,
                            'days': {}
                        };
                    }

                    const status = item['Trạng thái'];
                    const day = item['Ngày'];

                    // Cập nhật trạng thái cho ngày cụ thể
                    detailedData[key].days[day] = status;

                    // Tăng số lượng cho trạng thái tương ứng
                    if (status) {
                        detailedData[key][status] = (detailedData[key][status] || 0) + 1;
                    }
                });
                
                return Object.values(detailedData);
            }

            // Thêm sự kiện lắng nghe cho các bộ lọc
            filterDateSelect.addEventListener('change', filterData);
            filterDojoSelect.addEventListener('change', filterData);
            filterStudentInput.addEventListener('input', filterData);

            // Gọi hàm để lấy dữ liệu
            fetchData();
        });
    </script>
</body>
</html>
